<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PesoSave – Savings Weeks Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Theme color for browser UI -->
  <meta name="theme-color" content="#2563eb" />

  <!-- Favicon: use favicon.png from the root folder -->
  <link rel="icon" type="image/png" href="/favicon.png" />

  <!-- PWA Manifest -->
  <link rel="manifest" href="/manifest.webmanifest" />

  <style>
    :root {
      --primary: #2563eb;
      --primary-light: #dbeafe;
      --bg: #f3f4f6;
      --text: #111827;
      --muted: #6b7280;
      --danger: #dc2626;
      --success: #16a34a;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--primary); /* brand name in primary blue */
    }

    .brand-tagline {
      font-size: 0.85rem;
      color: var(--muted);
      margin-top: 0;
      margin-bottom: 1rem;
    }

    .card {
      background: #fff;
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
    }

    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 0.6rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      font-size: 1rem;
      margin-bottom: 0.75rem;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 1px var(--primary-light);
    }

    button {
      width: 100%;
      padding: 0.7rem;
      border-radius: 0.5rem;
      border: none;
      background: var(--primary);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }

    button:active {
      opacity: 0.9;
      transform: translateY(1px);
    }

    /* Icon-only settings button */
    .btn-ghost {
      width: auto;
      background: transparent;
      color: var(--primary);
      border: none;
      padding: 0.25rem;
      font-size: 0.85rem;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      cursor: pointer;
    }

    .btn-ghost:active {
      transform: none;
    }

    .icon-settings {
      width: 18px;
      height: 18px;
      stroke: currentColor;
      stroke-width: 1.8;
      fill: none;
    }

    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.3rem;
      gap: 0.5rem;
    }

    .stats {
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .stat {
      flex: 1;
      min-width: 45%;
      background: var(--primary-light);
      border-radius: 0.75rem;
      padding: 0.5rem;
      text-align: center;
      font-size: 0.85rem;
    }

    .stat strong {
      display: block;
      font-size: 1.1rem;
    }

    .history-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      padding: 0.4rem 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .history-item:last-child {
      border-bottom: none;
    }

    small {
      color: var(--muted);
    }

    .loading-banner {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .hidden {
      display: none;
    }

    .pill {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      background: #e5e7eb;
      font-size: 0.75rem;
      color: #374151;
    }

    .amount-positive {
      color: var(--success);
    }

    .amount-negative {
      color: var(--danger);
    }

    /* Modal backdrop + content for Settings */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.35s ease;
      z-index: 40;
    }

    .modal-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal {
      background: #ffffff;
      border-radius: 0.9rem;
      padding: 1rem 1rem 1rem;
      width: 100%;
      max-width: 420px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      transform: translateY(10px) scale(0.97);
      opacity: 0;
      border: none;
      transition:
        transform 0.35s ease,
        opacity 0.35s ease;
    }

    .modal-backdrop.open .modal {
      transform: translateY(0) scale(1);
      opacity: 1;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-close-btn {
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 1.2rem;
      width: auto;
      padding: 0.25rem;
      border-radius: 999px;
      cursor: pointer;
    }

    .modal-close-btn:active {
      transform: none;
      opacity: 0.7;
    }

    /* Toast (in-app notification) */
    .toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translate(-50%, 10px);
      background: #111827;
      color: #f9fafb;
      padding: 0.6rem 1rem;
      border-radius: 999px;
      font-size: 0.85rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.25);
      opacity: 0;
      transition: opacity 0.25s ease, transform 0.25s ease;
      z-index: 50;
      pointer-events: none;
      max-width: 90%;
      text-align: center;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header-row">
      <div>
        <h1>PesoSave</h1>
        <p class="brand-tagline">
          Track your peso savings in <strong>weeks of runway</strong>.
        </p>
      </div>
      <button
        id="toggleSettingsBtn"
        class="btn-ghost"
        aria-label="Open configuration"
      >
        <!-- Modern sliders icon -->
        <svg
          class="icon-settings"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <line x1="4" y1="7" x2="20" y2="7" />
          <circle cx="10" cy="7" r="2" />
          <line x1="4" y1="12" x2="20" y2="12" />
          <circle cx="15" cy="12" r="2" />
          <line x1="4" y1="17" x2="20" y2="17" />
          <circle cx="8" cy="17" r="2" />
        </svg>
      </button>
    </div>

    <div id="loadingBanner" class="loading-banner">
      Connecting to PesoSave…
    </div>

    <!-- Current Status -->
    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Current Status</h2>
      <div class="stats">
        <div class="stat">
          <small>Total Saved</small>
          <strong id="totalSavedDisplay">₱0</strong>
        </div>
        <div class="stat">
          <small>Weeks of Runway</small>
          <strong id="weeksDisplay">0</strong>
        </div>
      </div>
      <p style="font-size:0.85rem; margin-top:0.75rem;">
        Goal: <span id="goalDisplay">Not set</span>
      </p>
      <p style="font-size:0.85rem; margin-top:0.25rem;">
        Progress: <span id="progressDisplay">–</span>
      </p>
    </div>

    <!-- Add Savings -->
    <div class="card">
      <h2 style="font-size:1rem; margin-top:0;">Add Savings / Deductions</h2>
      <p style="font-size:0.8rem; margin-top:0; margin-bottom:0.5rem;">
        You can enter negative values for deductions (e.g. <strong>-200</strong> for withdrawing money).
      </p>

      <label for="amount">Amount (₱)</label>
      <input
        type="number"
        id="amount"
        placeholder="e.g. 500 or -200"
        step="0.01"
      />

      <label for="note">Note <small>(optional)</small></label>
      <input type="text" id="note" placeholder="e.g. salary, bonus, withdrawal" />

      <button id="addSavingBtn">Add Entry</button>
    </div>

    <!-- History -->
    <div class="card">
      <div class="header-row">
        <h2 style="font-size:1rem; margin-top:0;">History</h2>
        <span class="pill">Latest entries</span>
      </div>
      <div id="history"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-backdrop hidden">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-header">
        <h2 id="settingsTitle" class="modal-title">Configuration</h2>
        <button
          type="button"
          class="modal-close-btn"
          id="closeSettingsBtn"
          aria-label="Close"
        >
          ✕
        </button>
      </div>
      <p style="font-size:0.85rem; margin-top:0; margin-bottom:0.75rem;">
        Set your <strong>weekly expense</strong> and <strong>emergency fund goal</strong>.
      </p>

      <label for="weeklyExpense">Weekly Expense (₱)</label>
      <input type="number" id="weeklyExpense" placeholder="e.g. 1000" min="0" />

      <label for="goalAmount">
        Emergency Fund Goal (₱) <small>(optional)</small>
      </label>
      <input type="number" id="goalAmount" placeholder="e.g. 20000" min="0" />

      <button id="saveSettingsBtn">Save</button>
    </div>
  </div>

  <!-- In-app toast notification -->
  <div id="toast" class="toast"></div>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      collection,
      addDoc,
      query,
      orderBy,
      limit,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCcaEDYJnpAujmKsiOn9ARV08ztLt-hbYA",
      authDomain: "generic-5cae4.firebaseapp.com",
      projectId: "generic-5cae4",
      storageBucket: "generic-5cae4.firebasestorage.app",
      messagingSenderId: "107085769864",
      appId: "1:107085769864:web:457aec2d0632a51de9c33d"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State ---
    let currentUser = null;
    let settings = {
      weeklyExpense: 0,
      goalAmount: 0
    };
    let unsubscribeEntries = null;
    let toastTimeoutId = null;
    let currentEntries = [];

    // --- DOM elements ---
    const weeklyExpenseInput = document.getElementById("weeklyExpense");
    const goalAmountInput = document.getElementById("goalAmount");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");

    const totalSavedDisplay = document.getElementById("totalSavedDisplay");
    const weeksDisplay = document.getElementById("weeksDisplay");
    const goalDisplay = document.getElementById("goalDisplay");
    const progressDisplay = document.getElementById("progressDisplay");

    const amountInput = document.getElementById("amount");
    const noteInput = document.getElementById("note");
    const addSavingBtn = document.getElementById("addSavingBtn");
    const historyDiv = document.getElementById("history");

    const toggleSettingsBtn = document.getElementById("toggleSettingsBtn");
    const settingsModal = document.getElementById("settingsModal");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");

    const loadingBanner = document.getElementById("loadingBanner");
    const toast = document.getElementById("toast");

    // --- Helpers ---
    function formatPeso(value) {
      const num = Number(value) || 0;
      const abs = Math.abs(num).toLocaleString("en-PH", {
        maximumFractionDigits: 2
      });
      if (num < 0) return "-₱" + abs;
      return "₱" + abs;
    }

    function setLoading(text) {
      if (text) {
        loadingBanner.textContent = text;
        loadingBanner.classList.remove("hidden");
      } else {
        loadingBanner.classList.add("hidden");
      }
    }

    function showToast(message) {
      toast.textContent = message;
      toast.classList.add("show");

      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }
      toastTimeoutId = setTimeout(() => {
        toast.classList.remove("show");
      }, 2500);
    }

    function updateSettingsUI() {
      weeklyExpenseInput.value =
        settings.weeklyExpense != null ? settings.weeklyExpense : "";
      goalAmountInput.value =
        settings.goalAmount != null ? settings.goalAmount : "";
    }

    function renderHistory(entries) {
      historyDiv.innerHTML = "";
      if (!entries.length) {
        historyDiv.innerHTML =
          "<small>No entries yet. Add your first savings or deduction above.</small>";
        return;
      }

      entries.forEach((item) => {
        const div = document.createElement("div");
        div.className = "history-item";

        const amountClass =
          item.amount >= 0 ? "amount-positive" : "amount-negative";

        const left = document.createElement("div");
        left.innerHTML = `
          <strong class="${amountClass}">${formatPeso(item.amount)}</strong>
          <br/>
          <small>${item.note || ""}</small>
        `;

        const right = document.createElement("div");
        let dateText = "";
        if (item.createdAt && item.createdAt.toDate) {
          const date = item.createdAt.toDate();
          dateText = date.toLocaleDateString();
        }
        right.innerHTML = `<small>${dateText}</small>`;

        div.appendChild(left);
        div.appendChild(right);
        historyDiv.appendChild(div);
      });
    }

    function updateStats(entries) {
      const totalSaved = entries.reduce((sum, e) => sum + (e.amount || 0), 0);
      totalSavedDisplay.textContent = formatPeso(totalSaved);

      let weeksOfRunway = 0;
      if (settings.weeklyExpense > 0 && totalSaved > 0) {
        weeksOfRunway = Math.floor(totalSaved / settings.weeklyExpense);
      }
      weeksDisplay.textContent = weeksOfRunway;

      if (settings.goalAmount && settings.goalAmount > 0) {
        goalDisplay.textContent = formatPeso(settings.goalAmount);
        const progressRaw = (totalSaved / settings.goalAmount) * 100;
        const clamped = Math.min(100, Math.max(0, progressRaw));
        progressDisplay.textContent = clamped.toFixed(1) + "%";
      } else {
        goalDisplay.textContent = "Not set";
        progressDisplay.textContent = "–";
      }
    }

    // --- Firestore: paths ---
    function settingsDocRef(uid) {
      return doc(db, "users", uid, "meta", "settings");
    }

    function savingsCollectionRef(uid) {
      return collection(db, "users", uid, "savingsEntries");
    }

    async function loadSettings(uid) {
      const ref = settingsDocRef(uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        settings = snap.data();
      } else {
        settings = { weeklyExpense: 0, goalAmount: 0 };
      }
      updateSettingsUI();
    }

    function subscribeToEntries(uid) {
      if (unsubscribeEntries) unsubscribeEntries();

      const q = query(
        savingsCollectionRef(uid),
        orderBy("createdAt", "desc"),
        limit(50)
      );

      unsubscribeEntries = onSnapshot(
        q,
        (snapshot) => {
          const entries = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data()
          }));
          currentEntries = entries;
          renderHistory(entries);
          updateStats(entries);
          setLoading(null);
        },
        (error) => {
          console.error("Error listening to entries:", error);
          setLoading("Error loading data.");
          showToast("Error loading data from PesoSave.");
        }
      );
    }

    // --- Modal controls ---
    function openSettingsModal() {
      settingsModal.classList.remove("hidden");
      requestAnimationFrame(() => {
        settingsModal.classList.add("open");
      });
    }

    function closeSettingsModal() {
      settingsModal.classList.remove("open");
      setTimeout(() => {
        settingsModal.classList.add("hidden");
      }, 350);
    }

    toggleSettingsBtn.addEventListener("click", () => {
      openSettingsModal();
    });

    closeSettingsBtn.addEventListener("click", () => {
      closeSettingsModal();
    });

    settingsModal.addEventListener("click", (e) => {
      if (e.target === settingsModal) {
        closeSettingsModal();
      }
    });

    // --- Save settings (updates dashboard in real time) ---
    saveSettingsBtn.addEventListener("click", async () => {
      if (!currentUser) {
        showToast("Please wait, connecting to PesoSave…");
        return;
      }

      const weeklyExpense = Number(weeklyExpenseInput.value) || 0;
      const goalAmount = Number(goalAmountInput.value) || 0;

      settings.weeklyExpense = weeklyExpense;
      settings.goalAmount = goalAmount;

      try {
        await setDoc(
          settingsDocRef(currentUser.uid),
          {
            weeklyExpense,
            goalAmount,
            updatedAt: serverTimestamp()
          },
          { merge: true }
        );
        showToast("Settings saved ✅");
        updateStats(currentEntries); // recompute Goal/Progress immediately
        closeSettingsModal();
      } catch (err) {
        console.error(err);
        showToast("Failed to save settings. Please try again.");
      }
    });

    // --- Add savings entry ---
    addSavingBtn.addEventListener("click", async () => {
      if (!currentUser) {
        showToast("Please wait, connecting to PesoSave…");
        return;
      }

      const amount = Number(amountInput.value);
      if (!amount || amount === 0) {
        showToast("Please enter a non-zero amount (positive or negative).");
        return;
      }

      const note = noteInput.value.trim();

      try {
        await addDoc(savingsCollectionRef(currentUser.uid), {
          amount,
          note,
          createdAt: serverTimestamp()
        });
        amountInput.value = "";
        noteInput.value = "";
        showToast("Entry added ✅");
      } catch (err) {
        console.error(err);
        showToast("Failed to add entry. Please try again.");
      }
    });

    // --- Auth init ---
    setLoading("Connecting to PesoSave…");

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        setLoading("Loading your data…");
        try {
          await loadSettings(user.uid);
          subscribeToEntries(user.uid);
        } catch (err) {
          console.error(err);
          setLoading("Error loading your data.");
          showToast("Error loading your PesoSave data.");
        }
      } else {
        try {
          await signInAnonymously(auth);
        } catch (err) {
          console.error("Anonymous sign-in failed:", err);
          setLoading("Failed to connect to PesoSave.");
          showToast("Failed to connect to PesoSave.");
        }
      }
    });
  </script>

  <!-- Service Worker registration -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("/sw.js")
          .catch((err) => {
            console.log("Service worker registration failed:", err);
          });
      });
    }
  </script>
</body>
</html>
